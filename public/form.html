<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cell to Singularity Appeal Form</title>
    <link rel="stylesheet" href="appeal.css">

    <title>Cell to Singularity Appeal Form</title>
</head>

<body>
    <div class="header">
        <div>
            <img
                src="https://images-ext-1.discordapp.net/external/gd8gHhvGPSchhFFsytLnehgYOqhvvE6ePiVYnaa_6MU/https/cdn.discordapp.com/icons/488478892873744385/a_086f9cd39d45d52eddf3ac59df28e520.webp?size=64">
            <h1>Cell to Singularity Appeal Form</h1>
            <img id="avatar" alt="Your avatar">
            <h2 id="username"></h2>
        </div>
    </div>
    <div class="main">
        <form method="post" name="appeal" action="/success" netlify>
            <input type="hidden" id="token" name="token">
            <input type="hidden" id="email" name="email">
            <div class="inline-box">
                <div class="group">
                    <label for="caseid">Case ID</label><br />
                    <input type="text" id="caseid" name="caseid" maxlength="16"
                        placeholder="(if you have it)"></textarea>
                </div>
                <div class="group">
                    <label>Case Type</label><br />
                    <input type="radio" id="ban" name="casetype" value="ban" required>
                    <label class="smaller" for="ban">Ban</label>
                    <input type="radio" id="kick" name="casetype" value="kick" required>
                    <label class="smaller" for="kick">Kick</label>
                    <input type="radio" id="mute" name="casetype" value="mute" required>
                    <label class="smaller" for="mute">Mute</label>
                    <input type="radio" id="warning" name="casetype" value="warning" required>
                    <label class="smaller" for="warning">Warning</label>
                </div>
            </div>
            <div class="group">
                <label for="statement">User Statement</label>
                <div class="textInput">
                    <textarea class="full" id="statement" name="statement" required maxlength="1024"
                        rows="20"></textarea>
                    <div class="remainingLength"></div>
                </div>
            </div>
            <div class="group">
                <label for="reason">Why should we appeal your punishment?</label>
                <div class="textInput">
                    <textarea class="full" id="reason" name="reason" required maxlength="1024" rows="20"></textarea>
                    <div class="remainingLength"></div>
                </div>
            </div>
            <div class="flex">
                <input type="submit" class="submit" value="Submit">
            </div>
        </form>
    </div>

    <script>
        function parseJwt(token) {
            const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));

            return JSON.parse(jsonPayload);
        };

        const params = new URLSearchParams(document.location.search.substring(1));
        if (!params.has("state") || !params.has("token")) {
            window.location.href = `/error?msg=${encodeURIComponent("Missing state or token")}`;
        }

        if (params.get("state") !== localStorage.getItem("state")) {
            window.location.href = `/error?msg=${encodeURIComponent("Invalid state")}`;
        }

        const jwt = params.get("token");
        const userInfo = parseJwt(jwt);

        const avatar = userInfo.avatar
            ? `avatars/${encodeURIComponent(userInfo.id)}/${encodeURIComponent(userInfo.avatar)}.webp`
            : `embed/avatars/${userInfo.discriminator % 5}.png`;
        document.getElementById("avatar").src = `https://cdn.discordapp.com/${avatar}?size=64`;

        document.getElementById("username").textContent = `${userInfo.username}#${userInfo.discriminator}`;

        document.getElementById("email").value = userInfo.email;

        document.getElementById("token").value = jwt;

        [...document.getElementsByClassName("textInput")].forEach(div => {
            const textarea = div.firstElementChild;

            const updateTextarea = () => {
                textarea.style.height = "auto";
                textarea.style.height = `${textarea.scrollHeight}px`;

                const charactersRemaining = textarea.maxLength - textarea.textLength;
                const remainingLength = div.lastElementChild;
                if (charactersRemaining <= 100) {
                    remainingLength.classList.add("lowOnSpace");
                } else {
                    remainingLength.classList.remove("lowOnSpace");
                }
                remainingLength.textContent = charactersRemaining;
            }

            updateTextarea();
            textarea.oninput = updateTextarea;
        })
    </script>
</body>

</html>